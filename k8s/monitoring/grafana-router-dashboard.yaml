apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-router-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  router-golden-signals.json: |
    {
      "dashboard": {
        "title": "Cell Router - Golden Signals",
        "uid": "cell-router-golden",
        "tags": ["router", "golden-signals", "custom"],
        "timezone": "browser",
        "schemaVersion": 30,
        "version": 1,
        "panels": [
          {
            "title": "üö¶ Traffic - Request Rate by Cell",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
            "type": "graph",
            "targets": [
              {
                "expr": "sum(rate(router_requests_total[5m])) by (cell_id)",
                "legendFormat": "Cell {{cell_id}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {
                "format": "reqps",
                "label": "Requests/sec"
              },
              {
                "format": "short"
              }
            ]
          },
          {
            "title": "‚ùå Errors - Error Rate (%)",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
            "type": "graph",
            "targets": [
              {
                "expr": "(sum(rate(router_requests_total{status=~\"5..\"}[5m])) by (cell_id) / sum(rate(router_requests_total[5m])) by (cell_id)) * 100",
                "legendFormat": "Cell {{cell_id}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {
                "format": "percent",
                "label": "Error %"
              },
              {
                "format": "short"
              }
            ],
            "alert": {
              "conditions": [
                {
                  "evaluator": {
                    "params": [5],
                    "type": "gt"
                  },
                  "operator": {
                    "type": "and"
                  },
                  "query": {
                    "params": ["A", "5m", "now"]
                  },
                  "reducer": {
                    "params": [],
                    "type": "avg"
                  },
                  "type": "query"
                }
              ],
              "name": "High Error Rate Alert"
            }
          },
          {
            "title": "‚è±Ô∏è Latency - Request Duration (P50, P95, P99)",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.50, sum(rate(router_request_duration_seconds_bucket[5m])) by (cell_id, le))",
                "legendFormat": "P50 Cell {{cell_id}}",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.95, sum(rate(router_request_duration_seconds_bucket[5m])) by (cell_id, le))",
                "legendFormat": "P95 Cell {{cell_id}}",
                "refId": "B"
              },
              {
                "expr": "histogram_quantile(0.99, sum(rate(router_request_duration_seconds_bucket[5m])) by (cell_id, le))",
                "legendFormat": "P99 Cell {{cell_id}}",
                "refId": "C"
              }
            ],
            "yaxes": [
              {
                "format": "s",
                "label": "Duration"
              },
              {
                "format": "short"
              }
            ]
          },
          {
            "title": "üìä Saturation - CPU Usage",
            "gridPos": {"h": 8, "w": 6, "x": 12, "y": 8},
            "type": "graph",
            "targets": [
              {
                "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"router\",container=\"router\"}[5m])) by (pod) * 100",
                "legendFormat": "{{pod}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {
                "format": "percent",
                "label": "CPU %"
              },
              {
                "format": "short"
              }
            ]
          },
          {
            "title": "üìä Saturation - Memory Usage",
            "gridPos": {"h": 8, "w": 6, "x": 18, "y": 8},
            "type": "graph",
            "targets": [
              {
                "expr": "sum(container_memory_usage_bytes{namespace=\"router\",container=\"router\"}) by (pod) / 1024 / 1024",
                "legendFormat": "{{pod}}",
                "refId": "A"
              }
            ],
            "yaxes": [
              {
                "format": "decmbytes",
                "label": "Memory"
              },
              {
                "format": "short"
              }
            ]
          },
          {
            "title": "üî¥ Upstream Errors by Cell",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
            "type": "graph",
            "targets": [
              {
                "expr": "sum(rate(router_upstream_errors_total[5m])) by (upstream)",
                "legendFormat": "{{upstream}}",
                "refId": "A"
              }
            ]
          },
          {
            "title": "üîê Authentication Failures",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
            "type": "graph",
            "targets": [
              {
                "expr": "sum(rate(router_auth_failures_total[5m])) by (reason)",
                "legendFormat": "{{reason}}",
                "refId": "A"
              }
            ]
          },
          {
            "title": "üìà Total Requests (Counter)",
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 24},
            "type": "stat",
            "targets": [
              {
                "expr": "sum(router_requests_total)",
                "refId": "A"
              }
            ],
            "options": {
              "colorMode": "value",
              "graphMode": "area"
            }
          },
          {
            "title": "‚úÖ Success Rate",
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 24},
            "type": "stat",
            "targets": [
              {
                "expr": "(1 - (sum(rate(router_requests_total{status=~\"5..\"}[5m])) / sum(rate(router_requests_total[5m])))) * 100",
                "refId": "A"
              }
            ],
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "unit": "percent"
            }
          },
          {
            "title": "‚ö° Current QPS",
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 24},
            "type": "stat",
            "targets": [
              {
                "expr": "sum(rate(router_requests_total[1m]))",
                "refId": "A"
              }
            ],
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "unit": "reqps"
            }
          },
          {
            "title": "üéØ P95 Latency",
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 24},
            "type": "stat",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, sum(rate(router_request_duration_seconds_bucket[5m])) by (le))",
                "refId": "A"
              }
            ],
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "unit": "s"
            }
          }
        ]
      }
    }